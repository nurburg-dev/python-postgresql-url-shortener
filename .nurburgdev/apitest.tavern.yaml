test_name: Python URL Shortener API Tests
strict: false

stages:
  - name: Test health endpoint
    request:
      url: "{tavern.env_vars.HOST}/health"
      method: GET
    response:
      status_code: 200
      json:
        status: "OK"
        message: "URL Shortener API is running"

  - name: Create short URL with auto-generated key
    request:
      url: "{tavern.env_vars.HOST}/api/short_url"
      method: POST
      headers:
        Content-Type: application/json
      json:
        long_url: "https://www.myntra.com/sports-shoes/nike/nike-experience-run-11-womens-road-running-shoes/30739789/buy"
    response:
      status_code: 201
      json:
        key: !anystr
      save:
        json:
          auto_key: key

  - name: Create custom short URL
    request:
      url: "{tavern.env_vars.HOST}/api/short_url/custom"
      method: POST
      headers:
        Content-Type: application/json
      json:
        key: "summer-sales"
        long_url: "https://www.myntra.com/sports-shoes/nike/nike-experience-run-11-womens-road-running-shoes/30739789/buy"
    response:
      status_code: 201
      json:
        key: "summer-sales"

  - name: Test redirect with auto-generated key
    request:
      url: "{tavern.env_vars.HOST}/{auto_key}"
      method: GET
      redirect: false
    response:
      status_code: [302, 301]
      headers:
        Location: "https://www.myntra.com/sports-shoes/nike/nike-experience-run-11-womens-road-running-shoes/30739789/buy"

  - name: Test redirect with custom key
    request:
      url: "{tavern.env_vars.HOST}/summer-sales"
      method: GET
      redirect: false
    response:
      status_code: [302, 301]
      headers:
        Location: "https://www.myntra.com/sports-shoes/nike/nike-experience-run-11-womens-road-running-shoes/30739789/buy"

  - name: Test invalid short URL creation (missing long_url)
    request:
      url: "{tavern.env_vars.HOST}/api/short_url"
      method: POST
      headers:
        Content-Type: application/json
      json: {}
    response:
      status_code: 422

  - name: Test invalid custom URL creation (missing key)
    request:
      url: "{tavern.env_vars.HOST}/api/short_url/custom"
      method: POST
      headers:
        Content-Type: application/json
      json:
        long_url: "https://example.com"
    response:
      status_code: 422

  - name: Test non-existent key redirect
    request:
      url: "{tavern.env_vars.HOST}/non-existent-key"
      method: GET
    response:
      status_code: 404